name: CI/CD

on:
  push:
    branches: [ master, main, 'FEATURE_*' ]
  pull_request:
    branches: [ master, main ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/otel-collector

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate docker-compose.yml syntax
      run: |
        docker compose version
        docker compose config > /dev/null
        echo "✓ docker-compose.yml is valid"

    - name: Validate otel-collector-config.yaml
      run: |
        python3 -c "import yaml; yaml.safe_load(open('otel-collector-config.yaml'))"
        echo "✓ otel-collector-config.yaml is valid YAML"

    - name: Build and start services
      run: |
        docker network create deploy_default 2>/dev/null || true
        docker compose pull otel-collector
        docker compose up -d otel-collector
        sleep 10

    - name: Health check
      run: |
        echo "Running health check on otel-collector..."
        for i in {1..30}; do
          if curl -f -s http://localhost:13133/health > /dev/null 2>&1; then
            echo "✓ Health check passed"
            exit 0
          fi
          echo "Attempt $i/30 - waiting for collector..."
          sleep 2
        done
        echo "✗ Health check failed"
        docker compose logs otel-collector
        exit 1

    - name: Cleanup
      if: always()
      run: |
        docker compose down -v --remove-orphans 2>/dev/null || true
        docker network rm deploy_default 2>/dev/null || true

  build-and-push:
    needs: validate-and-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        # Sanitize branch name for Docker tag (replace / with -, remove special chars)
        TAG=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | tr '[:lower:]' '[:upper:]')
        
        # For master/main, also tag as latest
        if [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "main" ]; then
          TAGS="${TAG},latest"
        else
          TAGS="${TAG}"
        fi
        
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "Generated tags: ${TAGS}"

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.branch }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Push additional branch-based tags
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        # Create uppercase tag without slashes (e.g., FEATURE_TOBE-17497-OTEL)
        TAG=$(echo "$BRANCH_NAME" | tr '/' '-' | tr '[:lower:]' '[:upper:]')
        
        echo "Tagging and pushing as: ${TAG}"
        docker buildx imagetools create \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG} \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        # Also tag latest for main/master
        if [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "main" ]; then
          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        fi
